<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>å‡½æ•°æŒ‡é’ˆ,blockä¸lambdaè¡¨è¾¾å¼ - APIè°ƒç”¨å·¥ç¨‹å¸ˆçš„è¿›é˜¶</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="é£ç†Š" /><meta name="description" content="Cè¯­è¨€ä¸­çš„å‡½æ•°æŒ‡é’ˆ, OjbCä¸­çš„block,ä»¥åŠC&#43;&#43;å’ŒJavaä¸­çš„lambdaè¡¨è¾¾å¼éå¸¸ç±»ä¼¼. åœ¨å­¦ä¹ å•ä¸ªè¯­è¨€æ—¶ä¸ä¼šæƒ³åˆ°ä»–ä»¬ä¹‹é—´çš„å…±é€šç‚¹å’ŒåŒº" /><meta name="keywords" content="iOS, ç®—æ³•, Blog" />






<meta name="generator" content="Hugo 0.68.3 with theme even" />


<link rel="canonical" href="https://zhxiongfei.github.io/post/%E5%87%BD%E6%95%B0%E6%8C%87%E9%92%88block%E4%B8%8Elambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.e23b16f70676ed692f169c65f07230cd9d3e790a4b5b15dc32b1ee36e7604994.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="å‡½æ•°æŒ‡é’ˆ,blockä¸lambdaè¡¨è¾¾å¼" />
<meta property="og:description" content="Cè¯­è¨€ä¸­çš„å‡½æ•°æŒ‡é’ˆ, OjbCä¸­çš„block,ä»¥åŠC&#43;&#43;å’ŒJavaä¸­çš„lambdaè¡¨è¾¾å¼éå¸¸ç±»ä¼¼. åœ¨å­¦ä¹ å•ä¸ªè¯­è¨€æ—¶ä¸ä¼šæƒ³åˆ°ä»–ä»¬ä¹‹é—´çš„å…±é€šç‚¹å’ŒåŒº" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhxiongfei.github.io/post/%E5%87%BD%E6%95%B0%E6%8C%87%E9%92%88block%E4%B8%8Elambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/" />
<meta property="article:published_time" content="2020-07-07T00:56:36+08:00" />
<meta property="article:modified_time" content="2020-07-07T00:56:36+08:00" />
<meta itemprop="name" content="å‡½æ•°æŒ‡é’ˆ,blockä¸lambdaè¡¨è¾¾å¼">
<meta itemprop="description" content="Cè¯­è¨€ä¸­çš„å‡½æ•°æŒ‡é’ˆ, OjbCä¸­çš„block,ä»¥åŠC&#43;&#43;å’ŒJavaä¸­çš„lambdaè¡¨è¾¾å¼éå¸¸ç±»ä¼¼. åœ¨å­¦ä¹ å•ä¸ªè¯­è¨€æ—¶ä¸ä¼šæƒ³åˆ°ä»–ä»¬ä¹‹é—´çš„å…±é€šç‚¹å’ŒåŒº">
<meta itemprop="datePublished" content="2020-07-07T00:56:36&#43;08:00" />
<meta itemprop="dateModified" content="2020-07-07T00:56:36&#43;08:00" />
<meta itemprop="wordCount" content="7382">



<meta itemprop="keywords" content="iOS," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="å‡½æ•°æŒ‡é’ˆ,blockä¸lambdaè¡¨è¾¾å¼"/>
<meta name="twitter:description" content="Cè¯­è¨€ä¸­çš„å‡½æ•°æŒ‡é’ˆ, OjbCä¸­çš„block,ä»¥åŠC&#43;&#43;å’ŒJavaä¸­çš„lambdaè¡¨è¾¾å¼éå¸¸ç±»ä¼¼. åœ¨å­¦ä¹ å•ä¸ªè¯­è¨€æ—¶ä¸ä¼šæƒ³åˆ°ä»–ä»¬ä¹‹é—´çš„å…±é€šç‚¹å’ŒåŒº"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Fly</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">Abouts</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Fly</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">Abouts</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">å‡½æ•°æŒ‡é’ˆ,blockä¸lambdaè¡¨è¾¾å¼</h1>

      <div class="post-meta">
        <span class="post-time"> Jul 07 </span>
        
          <span class="more-meta"> 7382 words </span>
          <span class="more-meta"> 15 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#ä¸€-cå‡½æ•°æŒ‡é’ˆ">ä¸€, Cå‡½æ•°æŒ‡é’ˆ</a>
      <ul>
        <li><a href="#æ¦‚å¿µ">æ¦‚å¿µ</a></li>
        <li><a href="#ä»£ç ä¸¾ä¾‹">ä»£ç ä¸¾ä¾‹</a></li>
      </ul>
    </li>
    <li><a href="#äºŒ-c-lambdaè¡¨è¾¾å¼">äºŒ, C++ lambdaè¡¨è¾¾å¼</a>
      <ul>
        <li><a href="#æ¦‚å¿µ-1">æ¦‚å¿µ</a></li>
        <li><a href="#ä»£ç ä¸¾ä¾‹-1">ä»£ç ä¸¾ä¾‹</a></li>
        <li><a href="#æœ¬è´¨">æœ¬è´¨</a></li>
        <li><a href="#ä½œä¸ºå‚æ•°">ä½œä¸ºå‚æ•°</a></li>
        <li><a href="#å˜é‡æ•è·capture">å˜é‡æ•è·capture</a></li>
        <li><a href="#mutable">mutable</a></li>
      </ul>
    </li>
    <li><a href="#ä¸‰objc-block">ä¸‰,ObjC block</a>
      <ul>
        <li><a href="#ä»cçœ‹blockæœ¬è´¨">ä»C++çœ‹blockæœ¬è´¨</a></li>
        <li><a href="#block-çš„å˜é‡æ•è·-capture">block çš„å˜é‡æ•è· capture</a></li>
        <li><a href="#blockçš„ç±»å‹">blockçš„ç±»å‹</a></li>
        <li><a href="#blockä¸­è®¿é—®-å¯¹è±¡ç±»å‹çš„-autoå˜é‡">Blockä¸­è®¿é—® å¯¹è±¡ç±»å‹çš„ autoå˜é‡</a></li>
        <li><a href="#__blockçš„å†…å­˜ç®¡ç†">__blockçš„å†…å­˜ç®¡ç†</a></li>
        <li><a href="#å¯¹è±¡ç±»å‹çš„autoå˜é‡__blockå˜é‡">å¯¹è±¡ç±»å‹çš„autoå˜é‡ã€__blockå˜é‡</a></li>
        <li><a href="#è¢«__blockä¿®é¥°çš„å¯¹è±¡ç±»å‹">è¢«__blockä¿®é¥°çš„å¯¹è±¡ç±»å‹</a></li>
        <li><a href="#å¾ªç¯å¼•ç”¨é—®é¢˜">å¾ªç¯å¼•ç”¨é—®é¢˜</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><strong>Cè¯­è¨€</strong>ä¸­çš„<strong>å‡½æ•°æŒ‡é’ˆ</strong>, <strong>OjbC</strong>ä¸­çš„<strong>block</strong>,ä»¥åŠ<strong>C++</strong>å’Œ<strong>Java</strong>ä¸­çš„<strong>lambdaè¡¨è¾¾å¼</strong>éå¸¸ç±»ä¼¼.</p>
<p>åœ¨å­¦ä¹ å•ä¸ªè¯­è¨€æ—¶ä¸ä¼šæƒ³åˆ°ä»–ä»¬ä¹‹é—´çš„å…±é€šç‚¹å’ŒåŒºåˆ«ï¼Œæœ€è¿‘åœ¨å­¦ä¹ C++ å’Œ Javaè¯­æ³•æ—¶ï¼Œå‘è§‰<strong>lambdaè¡¨è¾¾å¼</strong>ï¼Œè¿™ä¸æ˜¯è·ŸObjCä¸­çš„ block éå¸¸ç›¸ä¼¼å—ï¼Ÿ</p>
<p>è¯´åˆ°åº•ä¸éƒ½æ˜¯ï¼Œå¯ä»¥<strong>æ•è·å˜é‡</strong>çš„<strong>æŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆ</strong>å—?</p>
<p>æ‰€ä»¥æ‰“ç®—å†™ä¸€ç¯‡æ€»ç»“å„è¯­è¨€ä¸­<strong>å‡½æ•°æŒ‡é’ˆ</strong>çš„ä½¿ç”¨çš„æ–‡ç« ã€‚</p>
<p>å› ä¸ºç¬”è€…æ˜¯iOSå¼€å‘äººå‘˜ï¼Œæ‰€ä»¥å¯¹ ObjCçš„blockä¼šä»‹ç»çš„è¯¦ç»†ä¸€äº›ã€‚ Cå‡½æ•°æŒ‡é’ˆ å’Œ C++ lambdaè¡¨è¾¾å¼ç®€å•è¿‡ä¸€ä¸‹ã€‚</p>
<h2 id="ä¸€-cå‡½æ•°æŒ‡é’ˆ">ä¸€, Cå‡½æ•°æŒ‡é’ˆ</h2>
<h3 id="æ¦‚å¿µ">æ¦‚å¿µ</h3>
<ul>
<li>åœ¨å­¦ä¹  Cè¯­è¨€æ—¶ï¼Œæˆ‘ä»¬å­¦åˆ°äº†<strong>å‡½æ•°æŒ‡é’ˆ</strong>ï¼Œå…¶å®šä¹‰å°±æ˜¯æŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆã€‚</li>
<li>é€šå¸¸<strong>æŒ‡é’ˆ</strong>æ˜¯æŒ‡å‘ä¸€ä¸ª<strong>å˜é‡</strong>ï¼Œè€Œ<strong>å‡½æ•°æŒ‡é’ˆ</strong>æ˜¯æŒ‡å‘å‡½æ•°ã€‚</li>
<li>å‡½æ•°æŒ‡é’ˆä¹Ÿå¯ä»¥åƒå‡½æ•°ä¸€æ ·ï¼Œ<strong>è°ƒç”¨</strong>å‡½æ•°ï¼Œ<strong>ä¼ é€’å‚æ•°</strong>ã€‚</li>
</ul>
<h3 id="ä»£ç ä¸¾ä¾‹">ä»£ç ä¸¾ä¾‹</h3>
<p>ä»¥ä¸‹ä»£ç æ˜¯ä¸€ä¸ªç®€å•çš„<strong>å‡½æ•°æŒ‡é’ˆ</strong>çš„ç”¨æ³•</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="c1">// å‡½æ•°
</span><span class="c1"></span><span class="kt">int</span> <span class="nf">sum</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">){</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="err">@</span><span class="n">autoreleasepool</span> <span class="p">{</span>       
        <span class="c1">// å®šä¹‰ä¹‹æˆ˜ ptr æŒ‡å‘ sumå‡½æ•°
</span><span class="c1"></span>        <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="o">=</span> <span class="n">sum</span><span class="p">;</span>
        <span class="c1">// é€šè¿‡ å‡½æ•°æŒ‡é’ˆ ptr è°ƒç”¨ sumå‡½æ•°
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="äºŒ-c-lambdaè¡¨è¾¾å¼">äºŒ, C++ lambdaè¡¨è¾¾å¼</h2>
<h3 id="æ¦‚å¿µ-1">æ¦‚å¿µ</h3>
<ul>
<li><strong>C++</strong>ä¸­çš„ <strong>lambdaè¡¨è¾¾å¼</strong> ç±»ä¼¼ ObjCä¸­çš„blockï¼Œå…¶æœ¬è´¨ä¸Šå°±æ˜¯<strong>å‡½æ•°</strong>.</li>
<li>å®Œæ•´ç»“æ„ : <strong>[capture list][paramas list]  mutable exception -&gt; return type{function body}</strong>
<ul>
<li><strong>capture list</strong> ï¼šæ•è·å¤–éƒ¨å˜é‡åˆ—è¡¨</li>
<li><strong>params list</strong> : å½¢å‚åˆ—è¡¨ï¼Œä¸èƒ½ä½¿ç”¨é»˜è®¤å‚æ•°, ä¸èƒ½çœç•¥å‚æ•°å</li>
<li><strong>mutable</strong> : ç”¨æ¥è¯´æ˜æ˜¯å¦å¯ä»¥ä¿®æ”¹æ•è·çš„å˜é‡</li>
<li><strong>exception</strong> : å¼‚å¸¸è®¾å®š</li>
<li><strong>return type</strong> : è¿”å›å€¼ç±»å‹</li>
<li><strong>function body</strong> : å‡½æ•°ä½“</li>
</ul>
</li>
<li>æœ‰æ—¶å¯ä»¥çœç•¥éƒ¨åˆ†ç»“æ„ :
<ul>
<li><strong>[capture list](params list) -&gt; return type{function body}</strong></li>
<li><strong>[capture list](params list) {function body}</strong></li>
<li><strong>[capture list]{function body}</strong></li>
</ul>
</li>
</ul>
<h3 id="ä»£ç ä¸¾ä¾‹-1">ä»£ç ä¸¾ä¾‹</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="c1">// å®šä¹‰ lambdaè¡¨è¾¾å¼
</span><span class="c1"></span>    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr1</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="o">=</span> <span class="p">[](</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">int</span><span class="p">{</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">ptr1</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>è€Œåœ¨ C++11ä»¥åï¼Œå¼•å…¥äº†<strong>è‡ªåŠ¨ç±»å‹æ¨æ–­</strong></li>
<li>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœç•¥ä¸Šè¾¹å¤æ‚çš„ç±»å‹å®šä¹‰ï¼Œ ç›´æ¥å†™ <strong>auto</strong></li>
<li>è‡ªåŠ¨ç±»å‹æ¨æ–­æ˜¯ç¼–è¯‘å™¨æ¥è¯†åˆ«æ¨æ–­ç±»å‹</li>
<li>åœ¨ç¼–è¯‘åå½¢æˆçš„æ±‡ç¼–ä»£ç ä¸­ï¼Œå’Œä¸»åŠ¨å†™çš„ç±»å‹æ²¡æœ‰ä»»ä½•åŒºåˆ«</li>
<li>ä¸ä¼šå½±å“ç¨‹åºæŒ‡å‘æ•ˆç‡</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="c1">// å®šä¹‰ lambdaè¡¨è¾¾å¼
</span><span class="c1"></span>    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr1</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="o">=</span> <span class="p">[](</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">int</span><span class="p">{</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">ptr1</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    
    <span class="c1">// å®šä¹‰ lambdaè¡¨è¾¾å¼
</span><span class="c1"></span>    <span class="c1">// C++11 åŠ å…¥è‡ªåŠ¨ç±»å‹æ¨æ–­
</span><span class="c1"></span>    <span class="c1">// æ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœç•¥ä¸Šè¾¹å¤æ‚çš„ ç±»å‹ï¼Œç›´æ¥å†™auto
</span><span class="c1"></span>    <span class="c1">// è‡ªåŠ¨ç±»å‹æ¨æ–­æ˜¯ç¼–è¯‘å™¨æ¥è¯†åˆ«æ¨æ–­ã€‚
</span><span class="c1"></span>    <span class="c1">// åœ¨ç¼–è¯‘åå½¢æˆçš„ä»£ç è·Ÿåˆ¶å®šç±»å‹æ²¡æœ‰åŒºåˆ«
</span><span class="c1"></span>    <span class="c1">// ä¸ä¼šå½±å“ç¨‹åºè¿è¡Œæ•ˆç‡
</span><span class="c1"></span>    <span class="k">auto</span> <span class="n">ptr2</span> <span class="o">=</span> <span class="p">[](</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">int</span><span class="p">{</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">ptr2</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="æœ¬è´¨">æœ¬è´¨</h3>
<p>lambdaè¡¨è¾¾å¼åœ¨ç¼–è¯‘æ—¶ï¼Œç¼–è¯‘å™¨ä¼šå°†<strong>lambdaè¡¨è¾¾å¼ç”Ÿæˆå‡½æ•°</strong>ï¼Œ æ‰€ä»¥ lambdaè¡¨è¾¾å¼çš„æœ¬è´¨å…¶å®å°±æ˜¯<strong>å‡½æ•°</strong>, è€Œlambdaè¡¨è¾¾å¼çš„è°ƒç”¨ï¼Œå…¶å®å°±æ˜¯<strong>å‡½æ•°è°ƒç”¨</strong>ã€‚</p>
<p>æˆ‘ä»¬ç”¨æ±‡ç¼–ä»£ç æ¥è¯æ˜è¿™ä¸ªé—®é¢˜ã€‚</p>
<ul>
<li>ä¸Šè¿°ä»£ç åœ¨è¿è¡Œæ—¶è½¬ä¸ºæ±‡ç¼–ä»¥åï¼Œå¯ä»¥çœ‹åˆ°ç¬¬ä¸€å¼ å›¾ä¸­ï¼Œæ˜¯å°† main.cpp æ–‡ä»¶çš„ç¬¬14è¡Œè½¬ä¸ºäº†ä¸€ä¸‹çš„æ±‡ç¼–ï¼Œè€Œç¬¬14è¡Œæ­£æ˜¯lambdaè¡¨è¾¾å¼ã€‚</li>
<li>æˆ‘ä»¬ä¸€æ­¥æ­¥è·Ÿè¿›å»æ±‡ç¼–ä»£ç ï¼Œåˆ°äº†ç¬¬äºŒå¼ å›¾å‡½æ•°çš„å®ç°ï¼Œå¯ä»¥çœ‹åˆ° ç¡®å®æ˜¯<strong>åŠ æ³•</strong>æ“ä½œ
<ul>
<li>ä¸€æ­¥æ­¥çš„ä½¿ç”¨å¯„å­˜å™¨èµ‹å€¼ï¼Œèµ‹å€¼åè¿›è¡ŒåŠ æ³•æ“ä½œï¼Œå†å°†ç»“æœè¿”å›</li>
</ul>
</li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ggggje2tcvj31ce0fyaen.jpg" alt="æˆªå±2020-07-05ä¸‹åˆ10.17.00"></p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ggggjjgmaaj31fw07cwgu.jpg" alt="æˆªå±2020-07-05ä¸‹åˆ10.17.56"></p>
<h3 id="ä½œä¸ºå‚æ•°">ä½œä¸ºå‚æ•°</h3>
<ul>
<li>å‡è®¾æˆ‘ä»¬æœ‰ åŠ å‡ä¹˜é™¤ å››ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯ä¼ å…¥ä¸¤ä¸ªæ•°å­—ï¼Œè¿›è¡ŒåŠ å‡ä¹˜é™¤æ“ä½œ</li>
<li>è¿˜æœ‰ä¸ª execæ–¹æ³•ï¼Œç”¨æ¥ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œå¹¶ä¼ å…¥å‡½æ•°åï¼Œè¿›è¡Œå¯¹åº”çš„åŠ å‡ä¹˜é™¤æ“ä½œ</li>
</ul>
<h4 id="ä¸ä½¿ç”¨-lambdaè¡¨è¾¾å¼">ä¸ä½¿ç”¨ lambdaè¡¨è¾¾å¼</h4>
<p>ä»£ç å¦‚ä¸‹ :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">v1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">v2</span><span class="p">){</span>
    <span class="k">return</span> <span class="n">v1</span> <span class="o">+</span> <span class="n">v2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">subtrace</span><span class="p">(</span><span class="kt">int</span> <span class="n">v1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">v2</span><span class="p">){</span>
    <span class="k">return</span> <span class="n">v1</span> <span class="o">-</span> <span class="n">v2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">multiply</span><span class="p">(</span><span class="kt">int</span> <span class="n">v1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">v2</span><span class="p">){</span>
    <span class="k">return</span> <span class="n">v1</span> <span class="o">*</span> <span class="n">v2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">divide</span><span class="p">(</span><span class="kt">int</span> <span class="n">v1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">v2</span><span class="p">){</span>
    <span class="k">return</span> <span class="n">v1</span> <span class="o">/</span> <span class="n">v2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">exec</span><span class="p">(</span><span class="kt">int</span> <span class="n">v1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">v2</span><span class="p">,</span> <span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">)){</span>
    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>

    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">exec</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">add</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">exec</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">subtrace</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">exec</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">multiply</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">exec</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">divide</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="ä½¿ç”¨-lambdaè¡¨è¾¾å¼">ä½¿ç”¨ lambdaè¡¨è¾¾å¼</h4>
<p>ä»£ç å¦‚ä¸‹ :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>

    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">exec</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="p">[](</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">){</span> <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span> <span class="p">})</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">exec</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="p">[](</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">){</span> <span class="k">return</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">;</span> <span class="p">})</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">exec</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="p">[](</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">){</span> <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span> <span class="p">})</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">exec</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="p">[](</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">){</span> <span class="k">return</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span><span class="p">;</span> <span class="p">})</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>ä¸Šè¿°ä»£ç æ‰§è¡Œå’Œä¸ä½¿ç”¨ ç¬¬ä¸€ç§å†™æ³• æ•ˆæœä¸€æ ·</li>
<li>ä»¥ä¸Šå°±æ˜¯ä½œä¸ºå‚æ•°ä½¿ç”¨çš„ä¾‹å­</li>
</ul>
<h3 id="å˜é‡æ•è·capture">å˜é‡æ•è·capture</h3>
<h4 id="æ¦‚å¿µ-2">æ¦‚å¿µ</h4>
<ul>
<li>ä¸­æ‹¬å· [] é‡Œè¾¹æ”¾çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿè²Œä¼¼æˆ‘ä»¬ä¸Šè¾¹ä¸€åªæ²¡æœ‰ç”¨åˆ°</li>
<li>[]é‡Œæ”¾å…¥çš„æ˜¯ç”¨æ¥åšå˜é‡æ•è·çš„ã€‚</li>
<li>æˆ‘ä»¬åœ¨ <strong>labmdaè¡¨è¾¾å¼</strong>ä¸­ä½¿ç”¨<strong>å¤–éƒ¨å±€éƒ¨å˜é‡</strong>æ—¶ï¼Œé»˜è®¤æ˜¯ä¸å¯ä»¥è®¿é—®çš„</li>
<li>éœ€è¦å°†å˜é‡åæ·»åŠ åˆ° [] ä¸­ï¼Œ æ‰å¯ä»¥è®¿é—®ã€‚</li>
</ul>
<h4 id="ä¸¾ä¾‹è¯´æ˜">ä¸¾ä¾‹è¯´æ˜</h4>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ggghhvxdxrj31fy0a475w.jpg" alt="æˆªå±2020-07-05ä¸‹åˆ10.51.02"></p>
<ul>
<li>æˆ‘ä»¬åœ¨ func ä¸­ï¼Œè®¿é—®å±€éƒ¨å˜é‡ a , æ˜¯ä¸å¯ä»¥ç›´æ¥è®¿é—®çš„ã€‚</li>
<li>å¦‚æœéœ€è¦è®¿é—®ï¼Œéœ€è¦å°†å˜é‡åæ”¾åˆ° [] ä¸­ï¼Œä»£ç å¦‚ä¸‹</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>

    <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
    <span class="k">auto</span> <span class="n">func</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]{</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="n">func</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>ä¸Šè¿°ä»£ç ä¸­ï¼Œ æˆ‘ä»¬å¯ä»¥ç›´æ¥è®¿é—®å˜é‡a å’Œ å˜é‡ b</li>
</ul>
<h4 id="å€¼æ•è·åœ°å€æ•è·">å€¼æ•è·ï¼Ÿåœ°å€æ•è·ï¼Ÿ</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>

    <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
    <span class="k">auto</span> <span class="n">func</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]{</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">};</span>
  	
  	<span class="n">a</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
  	<span class="n">b</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
  
    <span class="n">func</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>æˆ‘ä»¬å¯ä»¥è®¿é—® a, bå˜é‡ä»¥åï¼Œå¦‚æœæˆ‘ä»¬åç»­å°† aï¼Œ bçš„å€¼æ”¹äº†ï¼Œå†è°ƒç”¨ func() æ—¶ï¼Œè®¿é—®åˆ°çš„æ˜¯10ï¼Œ20è¿˜æ˜¯ 30ï¼Œ40å‘¢ï¼Ÿ
<ul>
<li>ç­”æ¡ˆæ˜¯10, 20</li>
</ul>
</li>
<li>why ?  çœ‹èµ·æ¥ï¼Œæˆ‘æ˜æ˜å°†ç”¨åˆ°çš„ a å’Œ b çš„å€¼æ”¹æ‰äº†ï¼Œä¸ºä»€ä¹ˆè®¿é—®è¿˜æ˜¯åŸæ¥çš„å€¼å‘¢ï¼Ÿ
<ul>
<li>å› ä¸ºè¿™é‡Œçš„å˜é‡æ•è·æ˜¯<strong>å€¼æ•è·</strong> ï¼Œä¹Ÿå°±æ˜¯è¯´funcç›´æ¥å°† 10ï¼Œ20 æ•è·äº†ï¼Œåè¾¹ä¿®æ”¹ aï¼Œbçš„å€¼è·Ÿfuncå†…éƒ¨æ•è·çš„å€¼å®Œå…¨æ²¡æœ‰å…³ç³»ã€‚</li>
</ul>
</li>
<li>å¦‚ä½•å®ç°ï¼Œåœ¨ aï¼Œbä¿®æ”¹ä»¥åï¼Œè°ƒç”¨ func() æ—¶ï¼Œè®¿é—®æ–°çš„ aï¼Œbçš„å€¼å‘¢ï¼Ÿ
<ul>
<li>ç­”æ¡ˆæ˜¯ <strong>åœ°å€æ•è·</strong>ï¼Œå¦‚ä½•åŠåˆ°åœ°å€æ•è·å‘¢ï¼Ÿ (ç±»ä¼¼åœ¨ç”¨çš„éå¸¸å¤šçš„ <strong>swap()<strong>å‡½æ•°ä¸­çš„</strong>åœ°å€å¼•ç”¨</strong>)
<ul>
<li>å¾ˆç®€å•ï¼Œæˆ‘ä»¬åœ¨ [] ä¸­æ•è·å˜é‡æ—¶ï¼Œç›´æ¥å¯¹aå–åœ°å€ï¼Œä¼ è¿›å»ï¼Œä¹Ÿå°±æ˜¯å°†&amp;aæ”¾å¤§ [] ä¸­</li>
<li>åœ°å€æ•è·ä»¥åï¼Œæˆ‘ä»¬å°±å¯ä»¥
<ul>
<li>åœ¨ func() å‡½æ•°è°ƒç”¨æ—¶ï¼Œæ ¹æ® a çš„åœ°å€ï¼Œæ‰¾åˆ° a æœ€æ–°çš„å€¼</li>
<li>å¹¶ä¸”ï¼Œå¯ä»¥æ ¹æ® a çš„åœ°å€ç»™ a èµ‹å€¼</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="mutable">mutable</h3>
<ul>
<li>åœ¨ä¸Šè¾¹å°æ®µçš„å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“å€¼æ•è·æ—¶ä¸å¯ä»¥ä¿®æ”¹å¼•ç”¨çš„å˜é‡çš„å€¼çš„ï¼Œå› ä¸ºæˆ‘ä»¬ç›¸å½“äºå•å•å¼•ç”¨äº†å€¼ï¼Œä¹Ÿå°±æ˜¯å¸¸é‡</li>
<li>è¿˜æœ‰å¦å¤–ä¸€ç§åšæ³•ï¼Œæ¥å®ç° åœ¨ func å†…éƒ¨ä¿®æ”¹ a çš„å€¼
<ul>
<li>ä½¿ç”¨ mutable å…³é”®å­—</li>
</ul>
</li>
<li>é¦–å…ˆæ˜ç¡®ä¸€ç‚¹ï¼Œ ä½¿ç”¨ mutableå…³é”®å­—åï¼Œ å˜é‡ä»ç„¶æ˜¯ <strong>å€¼æ•è·</strong></li>
<li>æ‰€ä»¥ï¼Œåœ¨ func å†…éƒ¨ä¸å¯èƒ½ä¿®æ”¹å¤–éƒ¨ a çš„å€¼</li>
<li>ä½†æ˜¯å¯ä»¥ä¿®æ”¹ func() å†…éƒ¨å˜é‡ a çš„å€¼</li>
<li><strong>mutable</strong>å…³é”®å­—åšæ³•ç±»ä¼¼äº
<ul>
<li>åœ¨ func() å‡½æ•°ä½“å†…éƒ¨ï¼Œåˆå§‹åŒ–äº†ä¸€ä¸ªå˜é‡ï¼Œåˆå§‹å€¼ä¸º a</li>
<li>æ‰€ä»¥åœ¨ func()å‡½æ•°é¢˜å†…éƒ¨ï¼Œå½“ç„¶å¯ä»¥ä¿®æ”¹ å…¶å†…éƒ¨çš„ a</li>
<li>ä½†æ˜¯æ— æ³•å¯¹å¤–éƒ¨çš„ a äº§ç”Ÿå½±å“ã€‚</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kt">int</span> <span class="nf">main</span><span class="o">(</span><span class="kt">int</span> <span class="n">argc</span><span class="o">,</span> <span class="kd">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="o">[])</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">10</span><span class="o">;</span>
    <span class="n">auto</span> <span class="n">func</span> <span class="o">=</span> <span class="o">[</span><span class="n">a</span><span class="o">]()</span> <span class="n">mutable</span><span class="o">{</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">20</span><span class="o">;</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;func -&gt; &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="o">;</span>
    <span class="o">};</span>
    <span class="n">func</span><span class="o">();</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="o">;</span>
    <span class="k">return</span> <span class="n">0</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>æ‰€ä»¥ä¸Šè¿°ä»£ç çš„æ‰“å°ç»“æœä¸º
<ul>
<li><strong>func -&gt; 20</strong></li>
<li><strong>10</strong>*</li>
<li><strong>Program ended with exit code: 0</strong></li>
</ul>
</li>
<li>å…¶å†…éƒ¨çš„aè¢«ä¿®æ”¹äº†ï¼Œä½†æ˜¯å¤–éƒ¨çš„å€¼ä»ç„¶æ˜¯åŸæ¥çš„å€¼ã€‚</li>
</ul>
<h2 id="ä¸‰objc-block">ä¸‰,ObjC block</h2>
<h3 id="ä»cçœ‹blockæœ¬è´¨">ä»C++çœ‹blockæœ¬è´¨</h3>
<ul>
<li>
<p>é¦–å…ˆæ¥çœ‹ä¸€ä¸ªæœ€ç®€å•çš„block, æ²¡æœ‰è¿”å›å€¼ï¼Œæ²¡æœ‰å‚æ•°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">block</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
   <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;a is %d&#34;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
<span class="p">};</span>
<span class="n">block</span><span class="p">();</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>æˆ‘ä»¬ç¼–å†™çš„ OCä»£ç ï¼Œåº•å±‚å®ç°å…¶å®éƒ½æ˜¯ C/C++ä»£ç </p>
</li>
<li>
<p>æ‰€ä»¥è¦ç†è§£ block çš„æœ¬è´¨ï¼Œ æˆ‘ä»¬å°†ä¸‹è¾¹ä»£ç è½¬æ¢ä¸º C++ ä»£ç </p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc main.m -o main.cpp
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>è½¬ä¸ºC++ä»£ç ä»¥å, æˆ‘ä»¬åˆ›å»ºå’Œè°ƒç”¨ block ä»£ç å¦‚ä¸‹ :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// blockçš„èµ‹å€¼ 
</span><span class="c1"></span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">block</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__main_block_impl_0</span><span class="p">(</span><span class="n">__main_block_func_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__main_block_desc_0_DATA</span><span class="p">,</span> <span class="n">a</span><span class="p">));</span>
<span class="c1">// blockçš„è°ƒç”¨
</span><span class="c1"></span><span class="n">block</span><span class="o">-&gt;</span><span class="n">FuncPtr</span><span class="p">();</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// blockç»“æ„ä½“
</span><span class="c1"></span><span class="k">struct</span> <span class="nc">__main_block_impl_0</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="nc">__block_impl</span> <span class="n">impl</span><span class="p">;</span>					<span class="c1">// å®ç°
</span><span class="c1"></span>  <span class="k">struct</span> <span class="nc">__main_block_desc_0</span><span class="o">*</span> <span class="n">Desc</span><span class="p">;</span> <span class="c1">// æè¿°
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">a</span><span class="p">;</span>														<span class="c1">// æ•è·çš„å˜é‡
</span><span class="c1"></span><span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// block çš„å®ç°ç»“æ„ä½“
</span><span class="c1"></span><span class="k">struct</span> <span class="nc">__block_impl</span> <span class="p">{</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">isa</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">Flags</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">Reserved</span><span class="p">;</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">FuncPtr</span><span class="p">;</span>	<span class="c1">// FuncPtræŒ‡å‘å‡½æ•°çš„å…·ä½“å®ç°
</span><span class="c1"></span><span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// block çš„æè¿°ä¿¡æ¯
</span><span class="c1"></span><span class="kd">static</span> <span class="n">struct</span> <span class="n">__main_block_desc_0</span> <span class="o">{</span>
  <span class="n">size_t</span> <span class="n">reserved</span><span class="o">;</span>
  <span class="n">size_t</span> <span class="n">Block_size</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// __block_impl çš„ funcPtræŒ‡å‘çš„å‡½æ•°å…·ä½“å®ç°
</span><span class="c1">// å°±æ˜¯ï¼Œæˆ‘ä»¬ç¼–å†™çš„ ObjC çš„ æ‰“å° &#34;a is %d&#34;, a
</span><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">__main_block_func_0</span><span class="p">(</span><span class="k">struct</span> <span class="nc">__main_block_impl_0</span> <span class="o">*</span><span class="n">__cself</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">__cself</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">;</span> <span class="c1">// bound by copy
</span><span class="c1"></span>      <span class="n">NSLog</span><span class="p">(</span><span class="o">***</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>ç»è¿‡è½¬ä¸º C++ ä»£ç ï¼Œåˆ†æåå‘ç°ï¼Œæˆ‘ä»¬åœ¨ ObjC ä¸­ç¼–å†™çš„ block ä»£ç ï¼Œåœ¨ C++ä¸­è½¬ä¸ºäº†<strong>ç»“æ„ä½“</strong></p>
</li>
<li>
<p>è¿™ä¸ªç»“æ„ä½“ä¸­ï¼ŒåŒ…å« block å‡½æ•°çš„å…·ä½“å®ç°ï¼Œblock çš„sizeç­‰ç­‰</p>
</li>
<li>
<p>å¹¶ä¸”åœ¨ blockç»“æ„ä½“ä¸­ï¼Œæœ‰æˆ‘ä»¬è®¿é—®çš„<strong>å¤–éƒ¨å±€éƒ¨å˜é‡ int a</strong></p>
</li>
</ul>
<h3 id="block-çš„å˜é‡æ•è·-capture">block çš„å˜é‡æ•è· capture</h3>
<h4 id="ä¸¾ä¾‹åˆ†æ">ä¸¾ä¾‹åˆ†æ</h4>
<ul>
<li>
<p>ä¸Šè¾¹çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬å¾—çŸ¥ block è®¿é—®çš„å¤–éƒ¨å±€éƒ¨å˜é‡ï¼Œè¢«<strong>æ•è·</strong>åˆ°äº†blockç»“æ„ä½“å†…éƒ¨</p>
</li>
<li>
<p>ä¸ºä»€ä¹ˆè¦æ•è·è¿™ä¸ªå˜é‡å‘¢ï¼Ÿ</p>
</li>
<li>
<p>ä¸¾ä¸ªğŸŒ°ï¼ŒæŸ¥çœ‹ä¸‹è¾¹ä»£ç  :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="k">@autoreleasepool</span> <span class="p">{</span>
        <span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">block</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
        <span class="p">{</span>
            <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
            <span class="n">block</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
                <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;a is %d&#34;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
            <span class="p">};</span>
        <span class="p">}</span>
        <span class="n">block</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>int a æ˜¯å±€éƒ¨å˜é‡, åœ¨èŠ±æ‹¬å·ç»“æŸåï¼Œ aå°±é‡Šæ”¾äº†</p>
</li>
<li>
<p>æ—¢ç„¶å®ƒé‡Šæ”¾äº†ï¼Œæˆ‘ä»¬åœ¨èŠ±æ‹¬å·å¤–è°ƒç”¨block() å¦‚ä½•è®¿é—® a å‘¢</p>
</li>
<li>
<p>è¿™å°±ç”¨åˆ°äº†<strong>å˜é‡æ•è·</strong>, è¦<strong>ä¿è¯æˆ‘ä»¬åœ¨ block å‡½æ•°ä½“ä¸­èƒ½è®¿é—®éœ€è¦çš„å±€éƒ¨å˜é‡ï¼Œæ‰€ä»¥éœ€è¦å˜é‡æ•è·ã€‚</strong></p>
</li>
</ul>
<h4 id="cåˆ†æ">C++åˆ†æ</h4>
<ul>
<li>
<p>ä»ä¸Šè¿° C++ ä»£ç å¯ä»¥çœ‹å‡ºï¼Œåœ¨æ„å»º block çš„ ç»“æ„ä½“æ—¶ï¼Œå°† å˜é‡ a ä¼ å…¥äº† ç»“æ„ä½“çš„<strong>æ„é€ å‡½æ•°</strong>ï¼Œ ä½¿ç”¨<strong>C++ä¸­åˆå§‹åŒ–åˆ—è¡¨</strong>ç»™ç»“æ„ä½“ä¸­çš„ a èµ‹å€¼</p>
</li>
<li>
<p>åœ¨**__main_block_func_0** ä¸­ï¼Œè®¿é—® a æ—¶ã€‚ ç›´æ¥å–å‡ºæ¥ **int a = __cself-&gt;a;** ,å†è¿›è¡Œè®¿é—®</p>
</li>
</ul>
<h4 id="å€¼å¼•ç”¨åœ°å€å¼•ç”¨">å€¼å¼•ç”¨ï¼Ÿåœ°å€å¼•ç”¨ï¼Ÿ</h4>
<h5 id="å€¼å¼•ç”¨">å€¼å¼•ç”¨</h5>
<p>å…ˆçœ‹å¦‚ä¸‹ä»£ç ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"> <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
 <span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">block</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span>  <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
     <span class="n">NSLog</span><span class="p">(</span><span class="err">@</span><span class="s">&#34;a is %d&#34;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
 <span class="p">};</span>
 <span class="n">a</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
 <span class="n">block</span><span class="p">();</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>é—®é¢˜ï¼š åœ¨ block ä¸­ è¾“å‡ºçš„ a æ˜¯10 è¿˜æ˜¯ 20 ï¼Ÿ</li>
<li>ç­”æ¡ˆæ˜¯ <strong>10</strong></li>
<li>ä¸ºä»€ä¹ˆæ˜¯10å‘¢ï¼Ÿ ä»ä¸Šè¿° C++ ä»£ç åˆ†æå¯ä»¥çœ‹å‡ºæ¥ï¼Œ æˆ‘ä»¬æ˜¯ç›´æ¥æ‹¿ a çš„å€¼ç›´æ¥ä¼ å…¥æ„é€ å‡½æ•°ï¼Œä¸ºç»“æ„ä½“ä¸­ a èµ‹å€¼</li>
<li>æ‰€ä»¥è¿™é‡Œæ˜¯<strong>å€¼å¼•ç”¨</strong>ï¼Œ ç›¸å½“äºè¿™é‡Œç›´æ¥æŠŠ 10 æ•è·åˆ°ç»“æ„ä½“ä¸­ï¼Œ å†ä¸ å˜é‡ a æ²¡æœ‰ä¸€ç‚¹å…³ç³»ã€‚</li>
<li>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆï¼Œåœ¨blockä¸­ä¸èƒ½ç»™ a èµ‹å€¼çš„åŸå› ï¼Œblockä¸­èƒ½è®¿é—®çš„ a ç›¸å½“äºæ˜¯å¸¸é‡ 10</li>
</ul>
<h5 id="åœ°å€å¼•ç”¨">åœ°å€å¼•ç”¨</h5>
<p>é‚£ä¹ˆï¼Œå¦‚ä½•èƒ½å®ç°, å¤–éƒ¨ a å˜åŒ–ä»¥åï¼Œblockå†…éƒ¨çš„ a ä¹Ÿå‘ç”Ÿå˜åŒ–ï¼Ÿä»¥åŠï¼Œå¦‚ä½•æ‰èƒ½åœ¨ block ä¸­ä¿®æ”¹ a çš„å€¼ï¼Ÿ</p>
<ul>
<li>ç­”æ¡ˆå°±æ˜¯ä½¿ç”¨ï¼Œ<strong>å¼•ç”¨ä¼ é€’</strong></li>
<li>é€šè¿‡å‰è¾¹ C++çš„å­¦ä¹ ï¼ŒC++çš„lambdaè¡¨è¾¾å¼éå¸¸æ–¹ä¾¿æ”¹ä¸ºå¼•ç”¨ä¼ é€’ï¼Œç›´æ¥åœ¨æ•è·åˆ—è¡¨ä¸­ æŠŠ a å˜ä¸º &amp;a å³å¯</li>
<li>è€Œåœ¨ ObjCä¸­ä¸å¯ä»¥æ˜¾å¼çš„è®¾ç½®æ•è·åˆ—è¡¨ã€‚OCä¸ºæˆ‘ä»¬æä¾›äº† <strong>__block</strong> å…³é”®å­—
<ul>
<li>ä½¿ç”¨ __block ä¿®é¥°çš„å˜é‡ï¼Œå¯ä»¥åœ¨ blockå‡½æ•°ä½“å†…éƒ¨èµ‹å€¼ï¼Œå¹¶ä¸”å¤–éƒ¨ä¿®æ”¹åï¼Œä¹Ÿå¯ä»¥å€¼åŒæ­¥</li>
</ul>
</li>
<li>æˆ‘ä»¬çŒœæƒ³ï¼Œä½¿ç”¨ __blockä¿®é¥°åçš„å˜é‡ï¼Œä»<strong>å€¼å¼•ç”¨éå†äº†åœ°å€å¼•ç”¨</strong></li>
<li>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡C++ä»£ç æ¥éªŒè¯æˆ‘ä»¬çš„çŒœæƒ³</li>
</ul>
<h5 id="ä»cä»£ç éªŒè¯__blockå…³é”®å­—">ä»C++ä»£ç éªŒè¯__blockå…³é”®å­—</h5>
<ul>
<li>åŒæ ·ï¼Œæˆ‘ä»¬æŠŠ main.m è½¬åŒ–ä¸º main.cpp</li>
<li>è½¬åŒ–ä¸º cppåï¼Œå‘ç°ä»£ç å˜å¾—ç‰¹åˆ«å¤æ‚ï¼Œæˆ‘ä»¬è¿™é‡Œç€é‡çœ‹é‡ç‚¹ä»£ç ï¼Œæ²¡å¿…è¦å»åˆ†ææ™¦æ¶©éš¾æ‡‚çš„å¤§é‡ C++ä»£ç </li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// blockçš„ç»“æ„ä½“
</span><span class="c1"></span><span class="k">struct</span> <span class="nc">__main_block_impl_0</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="nc">__block_impl</span> <span class="n">impl</span><span class="p">;</span>
  <span class="k">struct</span> <span class="nc">__main_block_desc_0</span><span class="o">*</span> <span class="n">Desc</span><span class="p">;</span>
  <span class="c1">// å°è£…äº†å˜é‡aåœ°å€çš„ç»“æ„ä½“
</span><span class="c1"></span>  <span class="n">__Block_byref_a_0</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span> <span class="c1">// by ref
</span><span class="c1"></span><span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="c1">// å˜é‡a åœ¨ __blockä¿®é¥°åï¼Œå˜ä¸ºç»“æ„ä½“ï¼Œå¹¶ä¸”ç»“æ„ä½“ä¸­åœ°å€å¼•ç”¨å˜é‡ a
</span><span class="c1"></span><span class="n">__Block_byref_a_0</span> <span class="n">a</span> <span class="o">=</span> <span class="p">{(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,(</span><span class="n">__Block_byref_a_0</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__Block_byref_a_0</span><span class="p">),</span> <span class="mi">10</span><span class="p">};</span>

<span class="n">block</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__main_block_impl_0</span><span class="p">(</span><span class="n">__main_block_func_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__main_block_desc_0_DATA</span><span class="p">,</span> <span class="p">(</span><span class="n">__Block_byref_a_0</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="mi">570425344</span><span class="p">));</span>

<span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">__forwarding</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">)</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

<span class="n">block</span><span class="o">-&gt;</span><span class="n">FuncPtr</span><span class="p">)();</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">struct</span> <span class="nc">__Block_byref_a_0</span> <span class="p">{</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">__isa</span><span class="p">;</span>
<span class="n">__Block_byref_a_0</span> <span class="o">*</span><span class="n">__forwarding</span><span class="p">;</span>
 <span class="kt">int</span> <span class="n">__flags</span><span class="p">;</span>
 <span class="kt">int</span> <span class="n">__size</span><span class="p">;</span>
 <span class="kt">int</span> <span class="n">a</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">static</span> <span class="kt">void</span> <span class="nf">__main_block_func_0</span><span class="p">(</span><span class="k">struct</span> <span class="nc">__main_block_impl_0</span> <span class="o">*</span><span class="n">__cself</span><span class="p">)</span> <span class="p">{</span>
  		<span class="n">__Block_byref_a_0</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">__cself</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">;</span> <span class="c1">// bound by ref
</span><span class="c1"></span>  		<span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">__forwarding</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">)</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>é‡ç‚¹ä»£ç æ˜¯ä»¥ä¸Šä¸‰æ®µä¸»è¦ä»£ç </p>
</li>
<li>
<p>å¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨ __blockä¿®é¥°çš„å˜é‡a, åœ¨å®šä¹‰æ—¶ï¼Œå°±è¢«å°è£…æˆäº†ä¸€ä¸ª ç»“æ„ä½“</p>
<ul>
<li><strong>__Block_byref_a_0</strong>
<ul>
<li>æ­¤ç»“æ„ä½“ä¸­ï¼Œisaåœ°å€æ˜¯ å˜é‡ a çš„åœ°å€</li>
<li>æœ‰ä¸€ä¸ªæŒ‡å‘è‡ªå·±çš„ <strong>__forwarding</strong>æŒ‡é’ˆæŒ‡å‘</li>
<li>è¿˜æœ‰ å˜é‡ a çš„å€¼</li>
</ul>
</li>
</ul>
</li>
<li>
<p>åœ¨ æ„é€  <strong>__main_block_impl_0</strong>  æ—¶ï¼Œä¼ å…¥çš„æ˜¯ <strong>__Block_byref_a_0</strong> çš„åœ°å€å€¼</p>
</li>
<li>
<p>å½“ è®¿é—® a  æ—¶ï¼Œç›´æ¥å–åˆ°çš„ __Block_byref_a_0ç»“æ„ä½“ çš„ (a.__forwarding-&gt;a) = 20; åœ°å€èµ‹å€¼</p>
</li>
<li>
<p>åœ¨å–å€¼æ—¶ï¼Œä»ç„¶æ˜¯ é€šè¿‡  __Block_byref_a_0ç»“æ„ä½“çš„ __forwwardingæŒ‡é’ˆï¼Œå†æ‰¾åˆ° a çš„åœ°å€æ¥ä¿®æ”¹çš„</p>
</li>
<li>
<p>æ€»ç»“æ¥è¯´ï¼Œå°±æ˜¯  ç”¨ <strong>__block</strong> ä¿®é¥°åï¼Œå˜é‡çš„<strong>å€¼å¼•ç”¨ å˜ä¸º åœ°å€å¼•ç”¨</strong></p>
<ul>
<li>æ‰€ä»¥å¯ä»¥é€šè¿‡åœ°å€æ¥è®¿é—®å˜é‡ a çš„æ›´æ”¹åçš„å€¼</li>
<li>ä¹Ÿå¯ä»¥é€šè¿‡åœ°å€æ¥ä¿®æ”¹å¤–éƒ¨å˜é‡ a çš„å€¼</li>
</ul>
</li>
<li>
<p>ä»¥ä¸Šæ˜¯å¯¹ <strong>å±€éƒ¨autoå˜é‡çš„æ€»ç»“</strong></p>
</li>
<li>
<p>ä¸‹è¾¹æˆ‘ä»¬çœ‹å¦å¤–ä¸€ç§æƒ…å†µï¼Œ staticå˜é‡</p>
</li>
</ul>
<h5 id="staticå˜é‡">staticå˜é‡</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">static</span> <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">block</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span>  <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;a is %d&#34;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
<span class="p">};</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">block</span><span class="p">();</span>
</code></pre></td></tr></table>
</div>
</div><p>ä»ç„¶ä½¿ç”¨å‘½ä»¤ï¼Œå°†ä»¥ä¸Šä»£ç è½¬åŒ–ä¸º C++ä»£ç ï¼Œå¦‚ä¸‹ :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">struct</span> <span class="nc">__main_block_impl_0</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="nc">__block_impl</span> <span class="n">impl</span><span class="p">;</span>
  <span class="k">struct</span> <span class="nc">__main_block_desc_0</span><span class="o">*</span> <span class="n">Desc</span><span class="p">;</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__main_block_func_0</span><span class="p">(</span><span class="k">struct</span> <span class="nc">__main_block_impl_0</span> <span class="o">*</span><span class="n">__cself</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">int</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">__cself</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">;</span> <span class="c1">// bound by copy
</span><span class="c1"></span>            <span class="n">NSLog</span><span class="p">(</span><span class="n">XXX</span>  <span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="cm">/* @autoreleasepool */</span> <span class="p">{</span> <span class="n">__AtAutoreleasePool</span> <span class="n">__autoreleasepool</span><span class="p">;</span>

        <span class="k">static</span> <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
        <span class="c1">// æ³¨æ„è¿™é‡Œæ˜¯ï¼Œåœ°å€å¼•ç”¨
</span><span class="c1"></span>        <span class="n">block</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__main_block_impl_0</span><span class="p">(</span><span class="n">__main_block_func_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__main_block_desc_0_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">));</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
        <span class="p">(</span><span class="n">block</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">FuncPtr</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>å¯ä»¥çœ‹å‡ºæ¥ï¼Œstaticå˜é‡ï¼Œåœ¨blockä¸­çš„å¼•ç”¨æ˜¯ <strong>åœ°å€å¼•ç”¨</strong></li>
<li>æ‰€ä»¥å¯ä»¥åœ¨blockä¸­ä¿®æ”¹å˜é‡çš„å€¼ã€‚</li>
<li>ä¸ºä»€ä¹ˆstaticå˜é‡æ˜¯<strong>åœ°å€å¼•ç”¨</strong>å‘¢ï¼Ÿ
<ul>
<li>çŒœæƒ³æ˜¯å› ä¸ºï¼Œstaticå˜é‡åœ¨å†…å­˜ä¸­åªæœ‰ä¸€ä»½ï¼Œä¸ä¼šè¢«é‡Šæ”¾ï¼Œä¸ä¼šå­˜åœ¨ï¼Œblockä¸­è®¿é—®æ—¶ï¼Œå˜é‡å·²è¢«é‡Šæ”¾çš„é£é™©</li>
<li>æ‰€ä»¥å¯ä»¥ç›´æ¥å¼•ç”¨åœ°å€</li>
</ul>
</li>
</ul>
<h5 id="å…¨å±€å˜é‡">å…¨å±€å˜é‡</h5>
<ul>
<li>å…¨å±€å˜é‡ä¸ä¼šè¿›è¡Œå˜é‡æ•è·</li>
<li>åœ¨ block å‡½æ•°ä½“ä¸­ï¼Œå¯ä»¥ç›´æ¥è®¿é—®å…¨å±€å˜é‡</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="k">@autoreleasepool</span> <span class="p">{</span>
        
        <span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">block</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span>  <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
            <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;a is %d&#34;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
        <span class="p">};</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
        <span class="n">block</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

<span class="k">struct</span> <span class="nc">__main_block_impl_0</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="nc">__block_impl</span> <span class="n">impl</span><span class="p">;</span>
  <span class="k">struct</span> <span class="nc">__main_block_desc_0</span><span class="o">*</span> <span class="n">Desc</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__main_block_func_0</span><span class="p">(</span><span class="k">struct</span> <span class="nc">__main_block_impl_0</span> <span class="o">*</span><span class="n">__cself</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="cm">/* @autoreleasepool */</span> <span class="p">{</span> <span class="n">__AtAutoreleasePool</span> <span class="n">__autoreleasepool</span><span class="p">;</span>

        <span class="n">block</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__main_block_impl_0</span><span class="p">(</span><span class="n">__main_block_func_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__main_block_desc_0_DATA</span><span class="p">));</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
        <span class="n">block</span><span class="o">-&gt;</span><span class="n">FuncPtr</span><span class="p">;</span>

    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="å˜é‡æ•è·æ€»ç»“-">å˜é‡æ•è·æ€»ç»“ :</h5>
<ul>
<li>å±€éƒ¨å˜é‡ä¼šè¢«æ•è·.
<ul>
<li>auto(é»˜è®¤) ç±»å‹çš„å±€éƒ¨å˜é‡æ˜¯å€¼æ•è·</li>
<li>static(é™æ€) ç±»å‹çš„å±€éƒ¨å˜é‡æ˜¯åœ°å€æ•è·</li>
</ul>
</li>
<li>å…¨å±€å˜é‡ä¸ä¼šè¢«æ•è·
<ul>
<li>å…¨å±€å˜é‡åœ¨ block å‡½æ•°ä½“ä¸­ï¼Œå¯ä»¥ç›´æ¥è®¿é—®ï¼Œä¸ä¼šè¢«æ•è·</li>
</ul>
</li>
</ul>
<h5 id="è¿›é˜¶---å¦ä¸€ç§å˜é‡">è¿›é˜¶ - å¦ä¸€ç§å˜é‡</h5>
<ul>
<li>ä¸‹è¾¹ä»£ç ä¸­ï¼Œ Personæ˜¯ä¸€ä¸ª ObjCç±»ï¼Œè¯·é—®åœ¨  test å‡½æ•°ä¸­çš„blockï¼Œæ˜¯å¦ä¼šæ•è· self ?</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">block</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">test</span><span class="p">{</span>
    <span class="n">block</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%p&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="nb">self</span><span class="p">);</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="nf">init</span><span class="p">{</span>
    <span class="nb">self</span> <span class="o">=</span> <span class="p">[</span><span class="nb">super</span> <span class="n">init</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[</span><span class="nb">self</span> <span class="n">test</span><span class="p">];</span>
        <span class="n">block</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>æ ¹æ®ä¸Šè¾¹çš„ç»éªŒï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œå¦‚æœå˜é‡æ˜¯ å±€éƒ¨å˜é‡ï¼Œå°±ä¼šè¢«æ•è·ã€‚</li>
<li>æ‰€ä»¥ä¸Šè¾¹çš„é—®é¢˜ï¼Œè½¬åŒ–æˆäº†ï¼Œtest å‡½æ•°ä¸­çš„ self æ˜¯å±€éƒ¨å˜é‡è¿˜æ˜¯å…¨å±€å˜é‡ ?</li>
<li>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æŠŠ Person.mè½¬æ¢æˆ .cppæ–‡ä»¶ï¼Œæ¥çª¥æ¢æ˜¯å¦è¢«æ•è·</li>
</ul>
<p>è½¬åŒ–ä¸º .cppåï¼Œä¸»è¦ä»£ç å¦‚ä¸‹ :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// block çš„å®šä¹‰
</span><span class="c1"></span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">block</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>

<span class="c1">// block ç»“æ„ä½“
</span><span class="c1"></span><span class="k">struct</span> <span class="nc">__Person__test_block_impl_0</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="nc">__block_impl</span> <span class="n">impl</span><span class="p">;</span>
  <span class="k">struct</span> <span class="nc">__Person__test_block_desc_0</span><span class="o">*</span> <span class="n">Desc</span><span class="p">;</span>
  <span class="n">Person</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// blockå®ç°å‡½æ•°
</span><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">__Person__test_block_func_0</span><span class="p">(</span><span class="k">struct</span> <span class="nc">__Person__test_block_impl_0</span> <span class="o">*</span><span class="n">__cself</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Person</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="n">__cself</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span> <span class="c1">// bound by copy
</span><span class="c1"></span>    <span class="n">NSLog</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// testå‡½æ•°çš„å®ç°
</span><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">_I_Person_test</span><span class="p">(</span><span class="n">Person</span> <span class="o">*</span> <span class="n">self</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">_cmd</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">block</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">__Person__test_block_impl_0</span><span class="p">(</span><span class="n">__Person__test_block_func_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__Person__test_block_desc_0_DATA</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="mi">570425344</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>æ ¹æ®ä¸Šé¢ä»£ç ï¼Œæˆ‘ä»¬å‘ç°ï¼š</li>
<li>self è¢«æ•è·åˆ° blockç»“æ„ä½“ä¸­äº†</li>
<li>è€Œä¸”æ˜¯<strong>å€¼æ•è·</strong>ï¼Œè¯´æ˜ self æ˜¯ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œè€Œéå…¨å±€å˜é‡</li>
<li>ä»testå‡½æ•°çš„å®ç° <strong>_I_Person_test</strong>å¯ä»¥çœ‹å‡ºï¼Œ testå‡½æ•°æœ‰ä¸¤ä¸ª<strong>éšå¼å‚æ•°</strong>
<ul>
<li>self,   è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨ å¯¹è±¡æ–¹æ³•ï¼Œå‡½æ•°ä½“ä¸­ï¼Œç›´æ¥è®¿é—® self çš„åŸå› </li>
<li>_cmdï¼Œ å‡½æ•°å.</li>
</ul>
</li>
</ul>
<h3 id="blockçš„ç±»å‹">blockçš„ç±»å‹</h3>
<ul>
<li>block æœ‰ä¸‰ç§ç±»å‹ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨ class å’Œ isaæŒ‡é’ˆæŸ¥çœ‹å…·ä½“ç±»å‹ï¼Œæœ€ç»ˆéƒ½ç»§æ‰¿è‡ª NSBlock ç±»å‹ï¼Œè€Œ NSBlock ç»§æ‰¿è‡ª NSObject
<ul>
<li><strong>NSGlobalBlock</strong> ï¼ˆ _NSConcreteGlobalBlock ï¼‰</li>
<li><strong>NSStackBlock</strong> ï¼ˆ _NSConcreteStackBlock ï¼‰</li>
<li><strong>NSMallocBlock</strong> ï¼ˆ _NSConcreteMallocBlock ï¼‰</li>
</ul>
</li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gghphr2viaj30uy0gyq7l.jpg" alt="æˆªå±2020-07-07ä¸Šåˆ12.13.02"></p>
<ul>
<li>
<p>ä¸ºäº†èƒ½æ›´å¥½çš„ç†è§£ï¼Œblockçš„ä¸‰ç§ç±»å‹ï¼Œæˆ‘ä»¬æœ€å¥½å…³é—­ <strong>ARC</strong>ï¼Œ å› ä¸ºARCç¯å¢ƒä¸‹ï¼Œç¼–è¯‘å™¨ä¼šå¸®æˆ‘ä»¬åšå¾ˆå¤šäº‹æƒ…ï¼Œ</p>
<ul>
<li>æ¯”å¦‚åœ¨æŒ‡é’ˆæŒ‡å‘æ—¶ï¼Œä¼šè‡ªåŠ¨æŠŠ block ä» æ ˆåŒºæ‹·è´åˆ°å †åŒºã€‚</li>
<li>ä¸åˆ©äºæˆ‘ä»¬å­¦ä¹  block çš„ä¸‰ç§ç±»å‹</li>
</ul>
</li>
<li>
<p>GlobalBlock æ˜¯æ²¡æœ‰è®¿é—®å¤–éƒ¨autoå±€éƒ¨å˜é‡çš„block</p>
<ul>
<li>å­˜æ”¾åœ¨ ç¨‹åºçš„<strong>æ•°æ®åŒºåŸŸ</strong>ï¼Œä¹Ÿå°±æ˜¯ä»£ç åŒº</li>
</ul>
</li>
<li>
<p>StackBlock è®¿é—®äº†å±€éƒ¨å˜é‡çš„block</p>
<ul>
<li>å­˜æ”¾åœ¨ <strong>æ ˆåŒº</strong></li>
</ul>
</li>
<li>
<p>MallocBlock è®¿é—®äº†å±€éƒ¨å˜é‡çš„blockï¼Œè°ƒç”¨äº†copyï¼Œå°±ä¼šè¢«å¤åˆ¶åˆ°å †åŒºï¼Œæˆä¸º MallocBlock</p>
<ul>
<li>å­˜æ”¾åœ¨ <strong>å †åŒº</strong></li>
</ul>
</li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gghpnhi2m2j30vc0g444j.jpg" alt="æˆªå±2020-07-07ä¸Šåˆ12.19.57"></p>
<h6 id="globalblock">GlobalBlock</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">block</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;GlobalBlock&#34;</span><span class="p">);</span>
<span class="p">};</span>
<span class="n">block</span><span class="p">();</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%@&#34;</span><span class="p">,</span> <span class="p">[</span><span class="n">block</span> <span class="k">class</span><span class="p">]);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>åƒè¿™ç§æ²¡æœ‰è®¿é—® autoå˜é‡çš„ blockï¼Œå…¶ç±»å‹ä¸º <strong>GlobalBlock</strong></li>
</ul>
<h6 id="stackblock">StackBlock</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">block</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;a is %d&#34;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
<span class="p">};</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%@&#34;</span><span class="p">,</span> <span class="p">[</span><span class="n">block</span> <span class="k">class</span><span class="p">]);</span>
<span class="n">block</span><span class="p">();</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>åƒè¿™ç§ï¼Œè®¿é—®äº†autoå±€éƒ¨å˜é‡çš„blockï¼Œ å…¶ç±»å‹ä¸º <strong>StackBlock</strong></li>
<li><strong>StackBlock</strong>å­˜æ”¾åœ¨æ ˆåŒºï¼Œè€Œå­˜æ”¾åœ¨æ ˆåŒºçš„æ•°æ®ï¼Œæ˜¯æœ‰ç¼–è¯‘å™¨å†³å®šå…¶ä»€ä¹ˆæ—¶å€™é‡Šæ”¾çš„ï¼Œç¨‹åºå‘˜æ— æ³•æ›´æ”¹</li>
<li>è¿™æ ·å°±å¾ˆæœ‰å¯èƒ½ï¼Œå½“æˆ‘ä»¬è®¿é—® <strong>StackBlock</strong>æ—¶ï¼Œblockå†…éƒ¨çš„å˜é‡å·²ç»è¢«é‡Šæ”¾ï¼Œæ— æ³•è®¿é—®</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">block</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">test</span><span class="p">(){</span>
    <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">block</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;a is %d&#34;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%@&#34;</span><span class="p">,</span> <span class="p">[</span><span class="n">block</span> <span class="k">class</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="k">@autoreleasepool</span> <span class="p">{</span>
        
        <span class="n">test</span><span class="p">();</span>
        <span class="n">block</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>æ¯”å¦‚ï¼Œä¸Šè¾¹ä»£ç ï¼Œblockè™½ç„¶å£°æ˜ä¸ºå…¨å±€ï¼Œ ä½†æ˜¯blockæ˜¯åœ¨<strong>æ ˆåŒº</strong>ï¼Œ å…¶å†…éƒ¨éœ€è¦çš„å˜é‡æ¯”å¦‚ a ä¹Ÿåœ¨æ ˆåŒºã€‚</p>
</li>
<li>
<p>å½“testå‡½æ•°ï¼ŒèŠ±æ‹¬å·ç»“æŸåï¼Œ æ ˆçš„å†…å­˜ç©ºé—´å·²ç»é”€æ¯</p>
</li>
<li>
<p>æ‰€ä»¥æ‰§è¡Œblockæ—¶ï¼Œå‡ºç°æ··ä¹±</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">2020-07-07 00:29:21.841482+0800 æµ‹è¯•<span class="o">[</span>12408:4050060<span class="o">]</span> __NSStackBlock__
2020-07-07 00:29:21.842224+0800 æµ‹è¯•<span class="o">[</span>12408:4050060<span class="o">]</span> a is -272632552
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>æ‰€ä»¥ï¼Œå¦‚ä½•é¿å…blockåœ¨æ ˆåŒºï¼Œè®¿é—®å˜é‡å¯èƒ½ä¼šè¢«éšæ—¶é”€æ¯ï¼Œç¨‹åºå‘˜æ— æ³•æ§åˆ¶çš„é—®é¢˜å‘¢ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯ ; å°† <strong>StackBlock</strong> æ‹·è´åˆ° <strong>å †åŒº</strong>ã€‚è€Œå †åŒºçš„å†…å­˜æ˜¯ç¨‹åºå‘˜å¯ä»¥æ§åˆ¶å…¶ç”Ÿå‘½å‘¨æœŸçš„ã€‚</p>
<h6 id="mallocblock">MallocBlock</h6>
<ul>
<li>
<p>ä¸Šè¾¹æˆ‘ä»¬æ€»ç»“è¿‡ï¼ŒStackBlockè°ƒç”¨ copy ï¼Œ ä¼šä»<strong>æ ˆåŒº</strong>æ‹·è´åˆ°<strong>å †åŒº</strong>ï¼Œ æˆä¸º<strong>MallocBlock</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">block</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
  
<span class="kt">void</span> <span class="nf">test</span><span class="p">(){</span>
    <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">block</span> <span class="o">=</span> <span class="p">[</span><span class="o">^</span><span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;a is %d&#34;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">copy</span><span class="p">];</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%@&#34;</span><span class="p">,</span> <span class="p">[</span><span class="n">block</span> <span class="k">class</span><span class="p">]);</span>
    <span class="p">[</span><span class="n">block</span> <span class="k">release</span><span class="p">];</span>
<span class="p">}</span>
  
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="k">@autoreleasepool</span> <span class="p">{</span>
          
        <span class="n">test</span><span class="p">();</span>
        <span class="n">block</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">2020-07-07 00:40:36.241385+0800 æµ‹è¯•<span class="o">[</span>12695:4058169<span class="o">]</span> __NSMallocBlock__
2020-07-07 00:40:36.242059+0800 æµ‹è¯•<span class="o">[</span>12695:4058169<span class="o">]</span> a is <span class="m">10</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>å¯ä»¥çœ‹åˆ°ï¼Œblockè°ƒç”¨copyä»¥åï¼ŒStackBlockæœç„¶å˜ä¸º MallocBlock,  å¹¶ä¸”å…¶ä¸­å±€éƒ¨å˜é‡å¯ä»¥è®¿é—®ã€‚</p>
</li>
<li>
<p>åœ¨ARCç¯å¢ƒä¸‹ï¼Œç¼–è¯‘å™¨ä¼šæ ¹æ®æƒ…å†µè‡ªåŠ¨å°†æ ˆä¸Šçš„blockå¤åˆ¶åˆ°å †ä¸Šï¼Œæ¯”å¦‚ä»¥ä¸‹æƒ…å†µ</p>
<ul>
<li>blockä½œä¸ºå‡½æ•°è¿”å›å€¼æ—¶</li>
<li>å°†blockèµ‹å€¼ç»™__strongæŒ‡é’ˆæ—¶</li>
<li>blockä½œä¸ºCocoa APIä¸­æ–¹æ³•åå«æœ‰usingBlockçš„æ–¹æ³•å‚æ•°æ—¶</li>
<li>blockä½œä¸ºGCD APIçš„æ–¹æ³•å‚æ•°æ—¶</li>
</ul>
</li>
<li>
<p>MRCä¸‹blockå±æ€§çš„å»ºè®®å†™æ³•</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">@property</span> <span class="p">(</span><span class="k">copy</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">)</span> <span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">block</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>ARCä¸‹blockå±æ€§çš„å»ºè®®å†™æ³•</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="o">-</span> <span class="k">@property</span> <span class="p">(</span><span class="k">strong</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">)</span> <span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">block</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
<span class="o">-</span> <span class="k">@property</span> <span class="p">(</span><span class="k">copy</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">)</span> <span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">block</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="blockä¸­è®¿é—®-å¯¹è±¡ç±»å‹çš„-autoå˜é‡">Blockä¸­è®¿é—® å¯¹è±¡ç±»å‹çš„ autoå˜é‡</h3>
<ul>
<li>
<p>å½“blockå†…éƒ¨è®¿é—®äº†å¯¹è±¡ç±»å‹çš„autoå˜é‡æ—¶</p>
<ul>
<li>å¦‚æœblockæ˜¯åœ¨æ ˆä¸Šï¼Œå°†ä¸ä¼šå¯¹autoå˜é‡äº§ç”Ÿå¼ºå¼•ç”¨</li>
</ul>
</li>
<li>
<p>å¦‚æœblockè¢«æ‹·è´åˆ°å †ä¸Š</p>
<ul>
<li>ä¼šè°ƒç”¨blockå†…éƒ¨çš„copyå‡½æ•°</li>
<li>copyå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨_Block_object_assignå‡½æ•°</li>
<li>_Block_object_assignå‡½æ•°ä¼šæ ¹æ®autoå˜é‡çš„ä¿®é¥°ç¬¦ï¼ˆ__strongã€__weakã€__unsafe_unretainedï¼‰åšå‡ºç›¸åº”çš„æ“ä½œï¼Œå½¢æˆå¼ºå¼•ç”¨ï¼ˆretainï¼‰æˆ–è€…å¼±å¼•ç”¨</li>
</ul>
</li>
<li>
<p>å¦‚æœblockä»å †ä¸Šç§»é™¤</p>
<ul>
<li>ä¼šè°ƒç”¨blockå†…éƒ¨çš„disposeå‡½æ•°</li>
<li>disposeå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨_Block_object_disposeå‡½æ•°</li>
<li>_Block_object_disposeå‡½æ•°ä¼šè‡ªåŠ¨é‡Šæ”¾å¼•ç”¨çš„autoå˜é‡ï¼ˆreleaseï¼‰</li>
</ul>
</li>
</ul>
<h3 id="__blockçš„å†…å­˜ç®¡ç†">__blockçš„å†…å­˜ç®¡ç†</h3>
<ul>
<li>
<p>å½“blockåœ¨æ ˆä¸Šæ—¶ï¼Œå¹¶ä¸ä¼šå¯¹__blockå˜é‡äº§ç”Ÿå¼ºå¼•ç”¨</p>
</li>
<li>
<p>å½“blockè¢«copyåˆ°å †æ—¶</p>
<ul>
<li>ä¼šè°ƒç”¨blockå†…éƒ¨çš„copyå‡½æ•°</li>
<li>copyå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨_Block_object_assignå‡½æ•°_</li>
<li>Block_object_assignå‡½æ•°ä¼šå¯¹__blockå˜é‡å½¢æˆå¼ºå¼•ç”¨ï¼ˆretainï¼‰</li>
</ul>
</li>
<li>
<p>å½“blockä»å †ä¸­ç§»é™¤æ—¶</p>
<ul>
<li>ä¼šè°ƒç”¨blockå†…éƒ¨çš„disposeå‡½æ•°</li>
<li>disposeå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨_Block_object_disposeå‡½æ•°</li>
<li>_Block_object_disposeå‡½æ•°ä¼šè‡ªåŠ¨é‡Šæ”¾å¼•ç”¨çš„__blockå˜é‡ï¼ˆreleaseï¼‰</li>
</ul>
</li>
</ul>
<h3 id="å¯¹è±¡ç±»å‹çš„autoå˜é‡__blockå˜é‡">å¯¹è±¡ç±»å‹çš„autoå˜é‡ã€__blockå˜é‡</h3>
<ul>
<li>å½“blockåœ¨æ ˆä¸Šæ—¶ï¼Œå¯¹å®ƒä»¬éƒ½ä¸ä¼šäº§ç”Ÿå¼ºå¼•ç”¨</li>
<li>å½“blockæ‹·è´åˆ°å †ä¸Šæ—¶ï¼Œéƒ½ä¼šé€šè¿‡copyå‡½æ•°æ¥å¤„ç†å®ƒä»¬
<ul>
<li>__blockå˜é‡ï¼ˆå‡è®¾å˜é‡åå«åšaï¼‰</li>
<li>Block_object_assign((void*)&amp;dst-&gt;a, (void*)src-&gt;a, 8/*BLOCK_FIELD_IS_BYREF*/);</li>
</ul>
</li>
<li>å¯¹è±¡ç±»å‹çš„autoå˜é‡ï¼ˆå‡è®¾å˜é‡åå«åšpï¼‰
<ul>
<li>_Block_object_assign((void*)&amp;dst-&gt;p, (void*)src-&gt;p, 3/*BLOCK_FIELD_IS_OBJECT*/)</li>
</ul>
</li>
<li>å½“blockä»å †ä¸Šç§»é™¤æ—¶ï¼Œéƒ½ä¼šé€šè¿‡disposeå‡½æ•°æ¥é‡Šæ”¾å®ƒä»¬
<ul>
<li>__blockå˜é‡ï¼ˆå‡è®¾å˜é‡åå«åšaï¼‰
<ul>
<li>Block_object_dispose((void*)src-&gt;a, 8/*BLOCK_FIELD_IS_BYREF*/);</li>
</ul>
</li>
<li>å¯¹è±¡ç±»å‹çš„autoå˜é‡ï¼ˆå‡è®¾å˜é‡åå«åšpï¼‰</li>
<li>_Block_object_dispose((void*)src-&gt;p, 3/*BLOCK_FIELD_IS_OBJECT*/);</li>
</ul>
</li>
</ul>
<h3 id="è¢«__blockä¿®é¥°çš„å¯¹è±¡ç±»å‹">è¢«__blockä¿®é¥°çš„å¯¹è±¡ç±»å‹</h3>
<ul>
<li>
<p>å½“__blockå˜é‡åœ¨æ ˆä¸Šæ—¶ï¼Œä¸ä¼šå¯¹æŒ‡å‘çš„å¯¹è±¡äº§ç”Ÿå¼ºå¼•ç”¨</p>
</li>
<li>
<p>å½“__blockå˜é‡è¢«copyåˆ°å †æ—¶</p>
<ul>
<li>ä¼šè°ƒç”¨__blockå˜é‡å†…éƒ¨çš„copyå‡½æ•°</li>
<li>copyå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨_Block_object_assignå‡½æ•°</li>
<li>_Block_object_assignå‡½æ•°ä¼šæ ¹æ®æ‰€æŒ‡å‘å¯¹è±¡çš„ä¿®é¥°ç¬¦ï¼ˆ__strongã€__weakã€__unsafe_unretainedï¼‰åšå‡ºç›¸åº”çš„æ“ä½œï¼Œå½¢æˆå¼ºå¼•ç”¨ï¼ˆretainï¼‰æˆ–è€…å¼±å¼•ç”¨ï¼ˆæ³¨æ„ï¼šè¿™é‡Œä»…é™äºARCæ—¶ä¼šretainï¼ŒMRCæ—¶ä¸ä¼šretainï¼‰</li>
</ul>
</li>
<li>
<p>å¦‚æœ__blockå˜é‡ä»å †ä¸Šç§»é™¤</p>
<ul>
<li>ä¼šè°ƒç”¨__blockå˜é‡å†…éƒ¨çš„disposeå‡½æ•°</li>
<li>disposeå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨_Block_object_disposeå‡½æ•°</li>
<li>_Block_object_disposeå‡½æ•°ä¼šè‡ªåŠ¨é‡Šæ”¾æŒ‡å‘çš„å¯¹è±¡ï¼ˆreleaseï¼‰</li>
</ul>
</li>
</ul>
<h3 id="å¾ªç¯å¼•ç”¨é—®é¢˜">å¾ªç¯å¼•ç”¨é—®é¢˜</h3>
<h4 id="è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜---arc">è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜ - ARC</h4>
<ul>
<li>
<p>ç”¨__weakã€__unsafe_unretainedè§£å†³</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ggiv016t1hj30ka09uwh9.jpg" alt="æˆªå±2020-07-08ä¸Šåˆ12.10.36"></p>
</li>
<li>
<p>ç”¨__blockè§£å†³ï¼ˆå¿…é¡»è¦è°ƒç”¨blockï¼‰</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ggiv0qu8f5j31ao07idm4.jpg" alt="æˆªå±2020-07-08ä¸Šåˆ12.11.19"></p>
</li>
</ul>
<h4 id="è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜---mrc">è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜ - MRC</h4>
<ul>
<li>
<p>ç”¨__unsafe_unretainedè§£å†³</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ggiv1gjdbuj30k004ugmv.jpg" alt="æˆªå±2020-07-08ä¸Šåˆ12.12.01"></p>
</li>
<li>
<p>ç”¨__blockè§£å†³</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ggiv2lw0cjj30eo04mq3x.jpg" alt="æˆªå±2020-07-08ä¸Šåˆ12.13.06"></p>
</li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">é£ç†Š</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        Jul 07
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/ios/">iOS</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/leetcode%E5%88%B7%E9%A2%98%E5%9B%9E%E9%A1%BE%E4%B8%8E%E6%80%BB%E7%BB%93/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">LeetCodeåˆ·é¢˜å›é¡¾ä¸æ€»ç»“</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/objc%E4%B8%AD%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E5%92%8Cproperty%E5%B1%9E%E6%80%A7%E7%9A%84%E5%8C%BA%E5%88%AB/">
            <span class="next-text nav-default">ObjCä¸­å…¨å±€å˜é‡å’Œ@propertyå±æ€§çš„åŒºåˆ«</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="310311589@qq.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/zhangxiongfeiv" class="iconfont icon-github" title="github"></a>
      <a href="https://leetcode-cn.com/u/zhangxiongfei/" class="iconfont icon-leetcode" title="leetcode"></a>
  <a href="https://zhxiongfei.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">é£ç†Š</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.d7b7ada643c9c1a983026e177f141f7363b4640d619caf01d8831a6718cd44ea.js"></script>








</body>
</html>
